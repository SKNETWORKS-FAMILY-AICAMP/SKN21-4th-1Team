{% extends 'base.html' %}

{% block title %}ì±„íŒ… | Labor Law Chatbot{% endblock %}

{% block extra_style %}
<style>
    * {
        box-sizing: border-box;
    }

    body {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    nav {
        flex-shrink: 0;
    }

    .chat-wrapper {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        overflow: hidden;
    }

    .chat-box {
        width: 800px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.12);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .messages {
        padding: 24px;
        flex: 1;
        overflow-y: auto;
    }

    .message {
        display: flex;
        margin-bottom: 10px;
    }

    .bubble {
        max-width: 70%;
        padding: 14px 18px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-line;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.bot {
        justify-content: flex-start;
    }

    .user .bubble {
        background: #2563eb;
        color: white;
    }

    .bot .bubble {
        background: #f3f4f6;
        color: #111;
    }

    .input-box {
        display: flex;
        padding: 12px;
        border-top: 1px solid #eee;
        border-radius: 0 0 20px 20px;
    }

    input {
        flex: 1;
        padding: 14px 16px;
        border-radius: 12px;
        border: 1px solid #ddd;
        outline: none;
        font-size: 14px;
    }

    button {
        margin-left: 10px;
        padding: 14px 24px;
        border-radius: 12px;
        border: none;
        background: #2563eb;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }

    button:hover {
        background: #1e40af;
    }

    .login-popup {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translate(-50%, 120%);
        width: 90%;
        max-width: 500px;
        background: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        text-align: center;
        transition: transform 0.4s ease-out;
    }

    .login-popup.show {
        transform: translate(-50%, 0);
    }

    .login-popup h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
        color: #111;
    }

    .login-popup p {
        margin: 0 0 20px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
    }

    .popup-btns {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .btn-later {
        flex: 1;
        padding: 12px;
        background: #f3f4f6;
        color: #4b5563;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-go-login {
        flex: 1;
        padding: 12px;
        background: #2563eb;
        color: white;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <form id="csrf-form" style="display: none;">
        {% csrf_token %}
    </form>

    <div class="chat-box">
        <div class="messages" id="messages"></div>

        <div class="input-box">
            <input type="text" id="messageInput" placeholder="ë…¸ë™ë²• ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <button onclick="sendMessage()">ì „ì†¡</button>
        </div>

        {% if not user.is_authenticated %}
        <div id="loginPopup" class="login-popup">
            <div class="popup-content">
                <h3>ëŒ€í™” ë‚´ìš©ì„ ì €ì¥í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</h3>
                <p>ë¡œê·¸ì¸í•˜ì‹œë©´ ì§€ê¸ˆ ë‚˜ëˆˆ ëŒ€í™” ê¸°ë¡ì„ ë‚˜ì¤‘ì—ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="popup-btns">
                    <button class="btn-later" onclick="closePopup()">ë‚˜ì¤‘ì— í•˜ê¸°</button>
                    <a href="{% url 'account_login' %}" class="btn-go-login">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const messages = document.getElementById("messages");

    function typeMessage(text, element, speed = 25) {
        let index = 0;
        element.textContent = "";
        const interval = setInterval(() => {
            if (index < text.length) {
                element.textContent += text[index++];
                messages.scrollTop = messages.scrollHeight;
            } else {
                clearInterval(interval);
            }
        }, speed);
    }

    window.onload = () => {
        const botMessage = document.createElement("div");
        botMessage.className = "message bot";
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        botMessage.appendChild(bubble);
        messages.appendChild(botMessage);

        typeMessage(
            "ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹\në…¸ë™ë²• AI ì±—ë´‡ì…ë‹ˆë‹¤.\nê¶ê¸ˆí•œ ë…¸ë™ë²• ê´€ë ¨ ì§ˆë¬¸ì„ í¸í•˜ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.",
            bubble
        );

        // í˜ì´ì§€ ë¡œë“œ í›„ 1.5ì´ˆ ë’¤ì— ë¡œê·¸ì¸ íŒì—… ë“±ì¥
        setTimeout(() => {
            const popup = document.getElementById('loginPopup');
            if (popup) popup.classList.add('show');
        }, 1500);
    };

    function closePopup() {
        const popup = document.getElementById('loginPopup');
        if (popup) popup.classList.remove('show');
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        messages.innerHTML += `
            <div class="message user">
                <div class="bubble">${message}</div>
            </div>
        `;
        input.value = "";
        messages.scrollTop = messages.scrollHeight;

        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message bot";
        const loadingBubble = document.createElement("div");
        loadingBubble.className = "bubble";
        loadingBubble.textContent = "ğŸ¤– AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...";
        loadingDiv.appendChild(loadingBubble);
        messages.appendChild(loadingDiv);
        messages.scrollTop = messages.scrollHeight;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch("/chat/api/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken
            },
            body: `message=${encodeURIComponent(message)}`
        })
            .then(res => res.json())
            .then(data => {
                loadingBubble.textContent = "";
                typeMessage(data.reply, loadingBubble);
            })
            .catch(error => {
                loadingBubble.textContent = `âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            });
    }
</script>
{% endblock %}