{% extends 'base.html' %}
{% load static %}

{% block title %}ì±„íŒ… | Labor Law Chatbot{% endblock %}

{% block extra_style %}
<style>
    * {
        box-sizing: border-box;
    }

    body {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        margin: 0;
        background-color: #f9fafb;
    }

    nav {
        z-index: 50;
        position: relative;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }

    .layout-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .sidebar {
        width: 260px;
        background-color: white;
        border-right: 1px solid #e5e7eb;
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.05);
        color: #374151;
        display: flex;
        flex-direction: column;
        padding: 20px 10px;
        overflow-y: auto;
        flex-shrink: 0;
        z-index: 10;
    }

    .btn-new-chat {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 12px;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        /* ë‘¥ê¸€ê²Œ */
        color: #374151;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        margin-bottom: 20px;
        text-decoration: none;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-new-chat:hover {
        border-color: #2563eb;
        color: #2563eb;
    }

    .session-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .session-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        color: #4b5563;
        text-decoration: none;
        font-size: 14px;
        transition: background 0.2s;
        cursor: pointer;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .session-item:hover {
        background-color: #dee6ff;
        color: #2563eb;
    }

    .session-item.active {
        background-color: #dee6ff;
        color: #2563eb;
        font-weight: 600;
    }

    .session-icon {
        margin-right: 10px;
        color: #9ca3af;
    }

    .session-item.active .session-icon {
        color: #5436da;
    }

    .session-title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        /* ì œëª©ì´ ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
    }

    /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .delete-btn {
        display: none;
        /* ê¸°ë³¸ ìˆ¨ê¹€ */
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        font-size: 12px;
        margin-left: 5px;
        border-radius: 4px;
    }

    .delete-btn:hover {
        color: #ef4444;
        /* ë¹¨ê°„ìƒ‰ hover */
        background-color: #fee2e2;
    }

    /* ì„¸ì…˜ ì•„ì´í…œ í˜¸ë²„ ì‹œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ */
    .session-item:hover .delete-btn {
        display: block;
    }

    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        background: white;
    }

    .message-container {
        width: 100%;
        height: fit-content;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        gap: 20px
    }

    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 40px 24px;
        padding-bottom: 120px;
        /* ì…ë ¥ì°½ ë†’ì´ë§Œí¼ ì—¬ë°± */
        scroll-behavior: smooth;
        display: flex;
        justify-content: center;
    }

    .message {
        display: flex;
        width: 100%;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.ai {
        justify-content: flex-start;
    }

    .message-content-wrapper {
        display: flex;
        max-width: 70%;
        gap: 12px;
        align-items: flex-end;
    }

    .message.user .message-content-wrapper {
        flex-direction: row-reverse;
    }

    .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 18px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .avatar.user {
        background: #eceaf4;
        color: white;
    }

    .avatar.ai {
        background: #c9dffd;
        color: white;
    }

    .bubble {
        padding: 20px 20px;
        /* 12px 16px -> 24px 28px ë¡œ ë³€ê²½ */
        font-size: 14px;
        line-height: 1.6;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        word-break: break-word;
    }

    .bubble p {
        margin: 0;
    }

    .bubble.markdown-msg>*:first-child {
        margin-top: 0;
    }

    .bubble.markdown-msg>*:last-child {
        margin-bottom: 0;
    }

    .bubble.markdown-msg p {
        margin-bottom: 12px;
        white-space: pre-wrap;
        /* ì—”í„° ì²˜ë¦¬ ë³´ì™„ */
    }

    .bubble.markdown-msg ul,
    .bubble.markdown-msg ol {
        margin-top: 8px;
        margin-bottom: 12px;
        padding-left: 24px;
    }

    .bubble.markdown-msg li {
        margin-bottom: 4px;
    }

    .bubble.markdown-msg li:last-child {
        margin-bottom: 0;
    }

    .bubble.markdown-msg h1,
    .bubble.markdown-msg h2,
    .bubble.markdown-msg h3,
    .bubble.markdown-msg h4 {
        margin-top: 20px;
        margin-bottom: 10px;
        font-weight: 600;
        line-height: 1.4;
    }

    .bubble.markdown-msg strong {
        font-weight: 700;
        color: #e5e7eb;
        /* AI ë§í’ì„  ë°°ê²½(ì–´ë‘ìš´ íŒŒë‘) ìœ„ì—ì„œëŠ” ë°ì€ìƒ‰ í•„ìš”... í•˜ì§€ë§Œ user bubble(íšŒìƒ‰)ì—ì„œëŠ”? */
    }

    /* ì‚¬ìš©ì ë§í’ì„ (íšŒìƒ‰)ê³¼ AI ë§í’ì„ (íŒŒë‘) í…ìŠ¤íŠ¸ ìƒ‰ìƒ êµ¬ë¶„ */
    .message.user .bubble.markdown-msg strong {
        color: #111827;
    }

    .message.ai .bubble.markdown-msg strong {
        color: #ffffff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .bubble.markdown-msg hr {
        border: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin: 16px 0;
    }

    .message.user .bubble.markdown-msg hr {
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .bubble.markdown-msg blockquote {
        margin: 12px 0;
        padding-left: 12px;
        border-left: 3px solid rgba(255, 255, 255, 0.5);
        opacity: 0.9;
    }

    .message.user .bubble.markdown-msg blockquote {
        border-left: 3px solid rgba(0, 0, 0, 0.2);
    }

    .message.user .bubble {
        background-color: #f3f4f6;
        color: #1f2937;
        border-radius: 18px 18px 0 18px;
    }

    .message.ai .bubble {
        background-color: #2e69c6;
        color: white;
        border-radius: 18px 18px 18px 0;
    }

    .message.ai .bubble.ing {
        display: flex;
    }

    .input-area {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 24px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #fff 20%);
        display: flex;
        justify-content: center;
    }

    .input-box {
        max-width: 800px;
        width: 100%;
        position: relative;
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 24px;
        /* ë” ë‘¥ê¸€ê²Œ */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 12px 20px;
    }

    input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 16px;
        padding: 4px;
        background: transparent;
        line-height: 24px;
        max-height: 200px;
        resize: none;
    }

    input,
    textarea {
        flex: 1;
        border: none;
        outline: none;
        font-size: 16px;
        padding: 4px;
        background: transparent;
        line-height: 24px;
        max-height: 200px;
        resize: none;
    }

    button.send-btn {
        background: #2563eb;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
    }

    button.send-btn:hover {
        background: #1e40af;
    }

    /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 24px;
    }

    .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: #2e69c6;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
        margin: 0 2px;
        opacity: 0.7;
    }

    .message.ai .typing-indicator span {
        background-color: white;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* Custom Modal CSS */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .custom-modal {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        max-width: 320px;
        width: 90%;
        text-align: center;
        animation: modalFadeIn 0.2s ease-out;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1f2937;
    }

    .modal-text {
        font-size: 14px;
        color: #4b5563;
        margin-bottom: 20px;
        line-height: 1.5;
        white-space: pre-line;
        /* \n ì¤„ë°”ê¿ˆ ë°˜ì˜ */
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .modal-btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
    }

    .modal-btn.cancel {
        background: #e5e7eb;
        color: #374151;
    }

    .modal-btn.cancel:hover {
        background: #d1d5db;
    }

    .modal-btn.confirm {
        background: #ef4444;
        color: white;
    }

    .modal-btn.confirm:hover {
        background: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<div class="layout-container">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <a href="{% url 'chat' %}" class="btn-new-chat">
            <span>+</span> ìƒˆë¡œìš´ ì±„íŒ…
        </a>

        <div class="session-list">
            {% for session in sidebar_sessions %}
            <a href="{% url 'chat_with_session' session.session_id %}"
                class="session-item {% if session.session_id == current_session_id %}active{% endif %}">
                <span class="session-icon">ğŸ’¬</span>
                <span class="session-title">{{ session.title }}</span>
                <button class="delete-btn" onclick="deleteSession(event, '{{ session.session_id }}')"
                    title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- ë©”ì¸ ì±„íŒ… -->
    <div class="chat-container">
        <div class="messages">
            <div class="message-container" id="messages">
                <!-- ì´ˆê¸° ì›°ì»´ ë©”ì‹œì§€ -->
                {% if not chat_history %}
                <div class="message ai">
                    <div class="message-content-wrapper">
                        <div class="avatar ai">ğŸ‘¨ğŸ½âš–ï¸</div>
                        <div class="bubble">ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹<br>ë…¸ë™ë²• AI ì±—ë´‡ì…ë‹ˆë‹¤.<br>ê¶ê¸ˆí•œ ë…¸ë™ë²• ê´€ë ¨ ì§ˆë¬¸ì„ í¸í•˜ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                    </div>
                </div>
                {% endif %}

                <!-- ëŒ€í™” ê¸°ë¡ -->
                {% for msg in chat_history %}
                <div class="message {% if msg.role == 'user' %}user{% else %}ai{% endif %}">
                    <div class="message-content-wrapper">
                        <div class="avatar {% if msg.role == 'user' %}user{% else %}ai{% endif %}">
                            {% if msg.role == 'user' %}ğŸ‘¤{% else %}ğŸ‘¨ğŸ½â€âš–ï¸
                            {% endif %}
                        </div>
                        <div class="bubble markdown-msg">{{ msg.message }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKeyPress(event)"
                    rows="1"></textarea>

                <button class="send-btn" id="sendBtn" onclick="handleSendOrStop()">
                    <svg id="sendIcon" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24"
                        stroke-linecap="round" stroke-linejoin="round" height="16" width="16"
                        xmlns="http://www.w3.org/2000/svg">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    <svg id="stopIcon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                        height="16" width="16" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <rect x="6" y="6" width="12" height="12" rx="1"></rect>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal-overlay">
    <div class="custom-modal">
        <div class="modal-title">ëŒ€í™” ì‚­ì œ</div>
        <div class="modal-text" id="modalText">ì •ë§ ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œë‚˜ìš”?
            í•œ ë²ˆ ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ì–´ìš”!âŒ</div>
        <div class="modal-buttons">
            <button id="btnCancel" class="modal-btn cancel">ì·¨ì†Œ</button>
            <button id="btnConfirm" class="modal-btn confirm">ì‚­ì œ</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/js/demo_automation.js"></script>
<script>

    let abortController = null;
    let isGenerating = false;
    let typingInterval = null;
    const messages = document.getElementById("messages");
    let currentSessionId = "{{ current_session_id|default_if_none:'' }}";

    // ìë™ ìŠ¤í¬ë¡¤
    function scrollToBottom() {
        if (messages.parentElement) {
            messages.parentElement.scrollTop = messages.parentElement.scrollHeight;
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ í•˜ë‹¨ ì´ë™ ë° ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
    window.onload = function () {
        const historyBubbles = document.querySelectorAll('.markdown-msg');
        historyBubbles.forEach(bubble => {
            const rawText = bubble.textContent;
            if (typeof marked !== 'undefined' && marked.parse) {
                bubble.innerHTML = marked.parse(rawText, {
                    breaks: true,
                    gfm: true
                });
            }
        });
        scrollToBottom();
    };

    function handleKeyPress(event) {
        if (event.isComposing) return;
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            if (!isGenerating) {
                sendMessage();
            }
        }
    }

    function handleSendOrStop() {
        if (isGenerating) {
            stopGeneration();
        } else {
            sendMessage();
        }
    }

    function toggleButton(generating) {
        const sendIcon = document.getElementById("sendIcon");
        const stopIcon = document.getElementById("stopIcon");

        if (generating) {
            sendIcon.style.display = "none";
            stopIcon.style.display = "block";
        } else {
            sendIcon.style.display = "block";
            stopIcon.style.display = "none";
        }
    }

    function stopGeneration() {
        if (abortController) {
            abortController.abort();
            abortController = null;
        }
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        isGenerating = false;
        toggleButton(false);
    }

    function typeMessage(text, element, speed = 10, onComplete = null) {
        let index = 0;
        let currentText = "";
        element.innerHTML = "";

        // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        if (typingInterval) clearInterval(typingInterval);

        typingInterval = setInterval(() => {
            if (index < text.length) {
                currentText += text[index++];
                if (typeof marked !== 'undefined' && marked.parse) {
                    element.innerHTML = marked.parse(currentText, {
                        breaks: true,
                        gfm: true
                    });
                } else {
                    element.textContent = currentText;
                }
                scrollToBottom();
            } else {
                clearInterval(typingInterval);
                typingInterval = null;
                // Ensure final consistency
                if (typeof marked !== 'undefined' && marked.parse) {
                    element.innerHTML = marked.parse(text, {
                        breaks: true,
                        gfm: true
                    });
                }

                // ì™„ë£Œ ì½œë°± ì‹¤í–‰
                if (onComplete) {
                    onComplete();
                }
            }
        }, speed);
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        const userDiv = document.createElement("div");
        userDiv.className = "message user";
        userDiv.innerHTML = `
            <div class="message-content-wrapper">
                <div class="avatar user">ğŸ‘¤</div>
                <div class="bubble">${message.replace(/\n/g, '<br>')}</div>
            </div>
        `;
        messages.appendChild(userDiv);
        input.value = "";
        scrollToBottom();

        // AI ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message ai";
        loadingDiv.style.display = 'flex';
        const bubbleId = "ai-bubble-" + Date.now();
        loadingDiv.innerHTML = `
            <div class="message-content-wrapper">
                <div class="avatar ai">ğŸ‘¨ğŸ½â€âš–ï¸</div>
                <div class="bubble ing markdown-msg" id="${bubbleId}">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        `;
        messages.appendChild(loadingDiv);
        scrollToBottom();

        const loadingBubble = document.getElementById(bubbleId);

        // ìƒì„± ìƒíƒœë¡œ ë³€ê²½
        isGenerating = true;
        toggleButton(true);
        abortController = new AbortController();

        // CSRF Token ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        fetch("/chat/api/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            }),
            signal: abortController.signal
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.session_id && currentSessionId !== data.session_id) {
                        currentSessionId = data.session_id;
                        window.history.pushState({}, '', '/chat/' + currentSessionId + '/');
                    }
                    loadingBubble.textContent = "";
                    loadingBubble.classList.remove("ing");
                    typeMessage(data.reply, loadingBubble, 15, () => {
                        // íƒ€ì´í•‘ì´ ëë‚˜ë©´ ì „ì†¡ ë²„íŠ¼ìœ¼ë¡œ ë³µê·€
                        isGenerating = false;
                        toggleButton(false);
                    });
                } else {
                    loadingBubble.textContent = "âš ï¸ ì˜¤ë¥˜ ë°œìƒ: " + data.message;
                    isGenerating = false;
                    toggleButton(false);
                }
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    loadingBubble.textContent = "ë‹µë³€ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
                } else {
                    loadingBubble.textContent = "âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
                    console.error(error);
                }
                isGenerating = false;
                toggleButton(false);
            })
            .finally(() => {
                abortController = null;
            });
    }

    // --- Custom Modal Logic ---
    let pendingDeleteSessionId = null;
    let pendingNextUrl = null;

    const modalOverlay = document.getElementById('deleteConfirmModal');
    const modalText = document.getElementById('modalText');
    const btnCancel = document.getElementById('btnCancel');
    const btnConfirm = document.getElementById('btnConfirm');

    function openDeleteModal(sessionId, nextUrl) {
        pendingDeleteSessionId = sessionId;
        pendingNextUrl = nextUrl;
        modalOverlay.classList.add('active');
    }

    function closeDeleteModal() {
        modalOverlay.classList.remove('active');
        pendingDeleteSessionId = null;
        pendingNextUrl = null;
    }

    btnCancel.addEventListener('click', closeDeleteModal);

    btnConfirm.addEventListener('click', () => {
        if (pendingDeleteSessionId) {
            executeDelete(pendingDeleteSessionId, pendingNextUrl);
        }
        closeDeleteModal();
    });

    // ì„¸ì…˜ ì‚­ì œ í•¨ìˆ˜ (ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
    function deleteSession(event, sessionId) {
        event.preventDefault();
        event.stopPropagation();

        // ë‹¤ìŒìœ¼ë¡œ ì´ë™í•  URL ê³„ì‚°
        const sessionItem = event.target.closest('.session-item');
        let nextRedirectUrl = "{% url 'chat' %}";

        if (sessionItem) {
            const nextItem = sessionItem.nextElementSibling;
            if (nextItem && nextItem.classList.contains('session-item')) {
                nextRedirectUrl = nextItem.getAttribute('href');
            }
        }

        // ëª¨ë‹¬ ì—´ê¸°
        openDeleteModal(sessionId, nextRedirectUrl);
    }

    // ì‹¤ì œ ì‚­ì œ ì‹¤í–‰ í•¨ìˆ˜ (ëª¨ë‹¬ í™•ì¸ í›„)
    function executeDelete(sessionId, nextRedirectUrl) {
        // CSRF Token ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        fetch(`/chat/delete/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (sessionId === currentSessionId) {
                        window.location.href = nextRedirectUrl;
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }
</script>

{% endblock %}